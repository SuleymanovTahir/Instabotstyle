<script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
        return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
    }
</script>{% extends "layouts/AdminLayout.html" %}

{% block content %}
<div class="p-8">
    <div class="mb-8">
        <h1 class="text-3xl text-gray-900 mb-2 flex items-center gap-3">
            <svg class="w-8 h-8 text-pink-600" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            Управление пользователями
        </h1>
        <p class="text-gray-600">{{ users | length }} пользователей</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p class="text-gray-500 text-sm mb-2">Всего пользователей</p>
            <h3 class="text-3xl text-gray-900">{{ users | length }}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p class="text-gray-500 text-sm mb-2">Администраторов</p>
            <h3 class="text-3xl text-purple-600">{{ users | selectattr("role", "equalto", "admin") | list | length }}
            </h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p class="text-gray-500 text-sm mb-2">Сотрудников</p>
            <h3 class="text-3xl text-purple-600">{{ users | selectattr("role", "equalto", "admin") | list | length }}
            </h3>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor"
                    viewBox="0 0 24 24">
                    <path
                        d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                </svg>
                <form method="get">
                    <input type="text" name="search" value="{{ search_term }}"
                        placeholder="Поиск по имени, логину или email..."
                        class="pl-10 w-full border border-gray-300 rounded-md p-2" />
                </form>
            </div>
            <a href="/admin/users/create"
                class="bg-pink-600 text-white rounded-md px-4 py-2 hover:bg-pink-700 flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                Добавить пользователя
            </a>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Пользователь</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Логин</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Email</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Роль</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Создан</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Действия</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for user in users %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-600 rounded-full flex items-center justify-center text-white">
                                    {{ user.name[0] }}
                                </div>
                                <div>
                                    <p class="text-sm text-gray-900">{{ user.name }} {{ user.surname }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ user.username }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ user.email }}</td>
                        <td class="px-6 py-4">
                            <span
                                class="{% if user.role == 'admin' %}bg-purple-100 text-purple-800{% elif user.role == 'manager' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %} inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                {{ 'Администратор' if user.role == 'admin' else 'Менеджер' if user.role == 'manager'
                                else 'Сотрудник' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ user.createdAt }}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <a href="#" class="border border-gray-300 rounded-md p-2 hover:bg-gray-50">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                    </svg>
                                </a>
                                <form method="post" action="/admin/users/delete/{{ user.id }}">
                                    <button type="submit"
                                        class="border border-gray-300 rounded-md p-2 text-red-600 hover:bg-gray-50">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path
                                                d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}