<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>{% extends "layouts/AdminLayout.html" %}

{% block content %}
<div class="p-8">
    <div class="mb-8">
        <h1 class="text-3xl text-gray-900 mb-2 flex items-center gap-3">
            <svg class="w-8 h-8 text-pink-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.06-.94l2.03-1.58a.5.5 0 00.06-.69l-2-3.46a.5.5 0 00-.61-.22l-2.39.96c-.5-.38-1.03-.7-1.59-.96l-.36-2.54a.5.5 0 00-.5-.44h-4a.5.5 0 00-.5.44l-.36 2.54c-.56.26-1.09.58-1.59.96l-2.39-.96a.5.5 0 00-.61.22l-2 3.46a.5.5 0 00.06.69l2.03 1.58c-.04.3-.06.61-.06.94s.02.64.06.94l-2.03 1.58a.5.5 0 00-.06.69l2 3.46a.5.5 0 00.61.22l2.39-.96c.5.38 1.03.7 1.59.96l.36 2.54a.5.5 0 00.5.44h4a.5.5 0 00.5-.44l.36-2.54c.56-.26 1.09-.58 1.59-.96l2.39.96a.5.5 0 00.61-.22l2-3.46a.5.5 0 00-.06-.69l-2.03-1.58z"/>
            </svg>
            Настройки системы
        </h1>
        <p class="text-gray-600">Управление параметрами CRM</p>
    </div>

    <div role="tablist" class="tabs tabs-boxed grid w-full grid-cols-4 lg:w-auto mb-6">
        <a role="tab" class="tab flex items-center gap-2" href="#general">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
            </svg>
            <span class="hidden sm:inline">Общие</span>
        </a>
        <a role="tab" class="tab flex items-center gap-2" href="#bot">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
            </svg>
            <span class="hidden sm:inline">Бот</span>
        </a>
        <a role="tab" class="tab flex items-center gap-2" href="#notifications">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
            </svg>
            <span class="hidden sm:inline">Уведомления</span>
        </a>
        <a role="tab" class="tab flex items-center gap-2" href="#security">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            <span class="hidden sm:inline">Безопасность</span>
        </a>
    </div>

    <!-- General -->
    <div id="general" class="tab-content bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <h2 class="text-2xl text-gray-900 mb-6">Основные настройки</h2>
        <form method="post" action="/admin/settings/general" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="salonName">Название салона *</label>
                    <input id="salonName" name="salonName" value="{{ general_settings.salonName }}" required class="input input-bordered w-full" />
                </div>
                <div>
                    <label for="language">Язык системы</label>
                    <select id="language" name="language" class="select select-bordered w-full">
                        <option value="ru" {% if general_settings.language == "ru" %}selected{% endif %}>Русский</option>
                        <option value="en" {% if general_settings.language == "en" %}selected{% endif %}>English</option>
                    </select>
                </div>
            </div>
            <div>
                <label for="city">Город</label>
                <input id="city" name="city" value="{{ general_settings.city }}" class="input input-bordered w-full" />
            </div>
            <div>
                <label for="address">Адрес</label>
                <input id="address" name="address" value="{{ general_settings.address }}" class="input input-bordered w-full" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="phone">Телефон</label>
                    <input id="phone" name="phone" value="{{ general_settings.phone }}" class="input input-bordered w-full" />
                </div>
                <div>
                    <label for="email">Email</label>
                    <input id="email" name="email" value="{{ general_settings.email }}" class="input input-bordered w-full" />
                </div>
            </div>
            <div>
                <label for="instagram">Instagram</label>
                <input id="instagram" name="instagram" value="{{ general_settings.instagram }}" class="input input-bordered w-full" />
            </div>
            <button type="submit" class="btn bg-pink-600 text-white">Сохранить</button>
        </form>
    </div>

    <!-- Bot -->
    <div id="bot" class="tab-content bg-white rounded-xl shadow-sm border border-gray-200 p-8 hidden">
        <h2 class="text-2xl text-gray-900 mb-6">Настройки бота</h2>
        <form method="post" action="/admin/settings/bot" class="space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-900">Бот активен</p>
                    <p class="text-xs text-gray-600">Обработка сообщений в Instagram</p>
                </div>
                <input type="checkbox" name="enabled" {% if bot_settings.enabled %}checked{% endif %} class="toggle toggle-primary" />
            </div>
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-900">Автоответы</p>
                    <p class="text-xs text-gray-600">Автоматические ответы на сообщения</p>
                </div>
                <input type="checkbox" name="autoReply" {% if bot_settings.autoReply %}checked{% endif %} class="toggle toggle-primary" />
            </div>
            <div>
                <label for="welcomeMessage">Приветственное сообщение</label>
                <textarea id="welcomeMessage" name="welcomeMessage" class="textarea textarea-bordered w-full">{{ bot_settings.welcomeMessage }}</textarea>
            </div>
            <div>
                <label for="bookingConfirmation">Подтверждение записи</label>
                <textarea id="bookingConfirmation" name="bookingConfirmation" class="textarea textarea-bordered w-full">{{ bot_settings.bookingConfirmation }}</textarea>
            </div>
            <div>
                <label for="reminderMessage">Напоминание о записи</label>
                <textarea id="reminderMessage" name="reminderMessage" class="textarea textarea-bordered w-full">{{ bot_settings.reminderMessage }}</textarea>
            </div>
            <div>
                <label for="workingHours">Часы работы</label>
                <input id="workingHours" name="workingHours" value="{{ bot_settings.workingHours }}" class="input input-bordered w-full" />
            </div>
            <button type="submit" class="btn bg-pink-600 text-white">Сохранить</button>
        </form>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="tab-content bg-white rounded-xl shadow-sm border border-gray-200 p-8 hidden">
        <h2 class="text-2xl text-gray-900 mb-6">Настройки уведомлений</h2>
        <form method="post" action="/admin/settings/notifications" class="space-y-6">
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-900">Email уведомления</p>
                        <p class="text-xs text-gray-600">Подтверждения, напоминания</p>
                    </div>
                    <input type="checkbox" name="emailNotifications" {% if notification_settings.emailNotifications %}checked{% endif %} class="toggle toggle-primary" />
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-900">SMS уведомления</p>
                        <p class="text-xs text-gray-600">Короткие сообщения на телефон</p>
                    </div>
                    <input type="checkbox" name="smsNotifications" {% if notification_settings.smsNotifications %}checked{% endif %} class="toggle toggle-primary" />
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-900">Push-уведомления</p>
                        <p class="text-xs text-gray-600">В приложении (если доступно)</p>
                    </div>
                    <input type="checkbox" name="pushNotifications" {% if notification_settings.pushNotifications %}checked{% endif %} class="toggle toggle-primary" />
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-900">Уведомления о записях</p>
                        <p class="text-xs text-gray-600">Для сотрудников о новых записях</p>
                    </div>
                    <input type="checkbox" name="bookingNotifications" {% if notification_settings.bookingNotifications %}checked{% endif %} class="toggle toggle-primary" />
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-900">Маркетинговые рассылки</p>
                        <p class="text-xs text-gray-600">Акции, специальные предложения</p>
                    </div>
                    <input type="checkbox" name="marketingEmails" {% if notification_settings.marketingEmails %}checked{% endif %} class="toggle toggle-primary" />
                </div>
                <div class="p-4 bg-gray-50 rounded-lg space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-900">Напоминания о днях рождения</p>
                            <p class="text-xs text-gray-600">Уведомления сотрудников о ДР клиентов</p>
                        </div>
                        <input type="checkbox" name="birthdayReminders" {% if notification_settings.birthdayReminders %}checked{% endif %} class="toggle toggle-primary" />
                    </div>
                    {% if notification_settings.birthdayReminders %}
                        <div>
                            <label for="birthdayDaysAdvance">Напоминать за (дней)</label>
                            <select id="birthdayDaysAdvance" name="birthdayDaysAdvance" class="select select-bordered w-full">
                                <option value="3" {% if notification_settings.birthdayDaysAdvance == 3 %}selected{% endif %}>3 дня</option>
                                <option value="7" {% if notification_settings.birthdayDaysAdvance == 7 %}selected{% endif %}>7 дней (неделя)</option>
                                <option value="14" {% if notification_settings.birthdayDaysAdvance == 14 %}selected{% endif %}>14 дней (2 недели)</option>
                            </select>
                        </div>
                    {% endif %}
                </div>
            </div>
            <button type="submit" class="btn bg-pink-600 text-white">Сохранить</button>
        </form>
    </div>

    <!-- Security -->
    <div id="security" class="tab-content bg-white rounded-xl shadow-sm border border-gray-200 p-8 hidden">
        <h2 class="text-2xl text-gray-900 mb-6">Безопасность и доступ</h2>
        <div class="space-y-6">
            <div class="p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-yellow-600 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                    <div>
                        <h3 class="text-sm text-gray-900 mb-2">Рекомендации по безопасности</h3>
                        <ul class="text-sm text-gray-700 space-y-2">
                            <li>• Используйте сложные пароли (минимум 8 символов)</li>
                            <li>• Регулярно меняйте пароли сотрудников</li>
                            <li>• Не передавайте учетные данные третьим лицам</li>
                            <li>• Проверяйте активные сессии пользователей</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div>
                <h3 class="text-lg text-gray-900 mb-4">Управление сессиями</h3>
                <p class="text-sm text-gray-600 mb-4">Просмотрите активные сессии пользователей и завершите подозрительные соединения</p>
                <button class="btn btn-outline">Просмотреть активные сессии</button>
            </div>
            <div>
                <h3 class="text-lg text-gray-900 mb-4">Резервное копирование</h3>
                <p class="text-sm text-gray-600 mb-4">Скачайте резервную копию всех данных системы</p>
                <button class="btn btn-outline">Скачать данные</button>
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll('[role="tab"]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const target = tab.getAttribute('href').substring(1);
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(target).classList.remove('hidden');
                document.querySelectorAll('[role="tab"]').forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
            });
        });
    </script>
</div>
{% endblock %}