<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>{% extends "layouts/AdminLayout.html" %}

{% block content %}
<div class="p-8">
    <div class="mb-8">
        <h1 class="text-3xl text-gray-900 mb-2 flex items-center gap-3">
            <svg class="w-8 h-8 text-pink-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M3 3h18v18H3z"/>
            </svg>
            Управление услугами
        </h1>
        <p class="text-gray-600">{{ services | length }} услуг</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p class="text-gray-500 text-sm mb-2">Всего услуг</p>
            <h3 class="text-3xl text-gray-900">{{ services | length }}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p class="text-gray-500 text-sm mb-2">Активных</p>
            <h3 class="text-3xl text-green-600">{{ services | selectattr("active") | list | length }}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <p class="text-gray-500 text-sm mb-2">Категорий</p>
            <h3 class="text-3xl text-purple-600">{{ categories | length }}</h3>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input
                    type="text"
                    name="search"
                    value="{{ search_term }}"
                    placeholder="Поиск по названию услуги..."
                    class="pl-10 w-full border border-gray-300 rounded-md p-2"
                />
            </div>
            <select name="category" class="w-full md:w-[200px] border border-gray-300 rounded-md p-2">
                <option value="all" {% if category_filter == "all" %}selected{% endif %}>Все категории</option>
                {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
            <button onclick="document.getElementById('serviceModal').showModal()" class="bg-pink-600 text-white rounded-md px-4 py-2 hover:bg-pink-700 flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 4v16m8-8H4"/>
                </svg>
                Добавить услугу
            </button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Услуга</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Категория</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Цена</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Описание</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Преимущества</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Статус</th>
                        <th class="px-6 py-4 text-left text-sm text-gray-600">Действия</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for service in filtered_services %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4">
                                <p class="text-sm text-gray-900">{{ service.nameRu }}</p>
                                <p class="text-xs text-gray-500">{{ service.name }}</p>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">{{ service.category }}</td>
                            <td class="px-6 py-4 text-sm text-green-600">{{ service.price }} {{ service.currency }}</td>
                            <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">{{ service.descriptionRu }}</td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1">
                                    {% for benefit in service.benefits %}
                                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">{{ benefit }}</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="{% if service.active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                    {{ 'Активна' if service.active else 'Отключена' }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <button onclick="editService({{ service | tojson }})" class="border border-gray-300 rounded-md p-2 hover:bg-gray-50">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                        </svg>
                                    </button>
                                    <form method="post" action="/admin/services/delete/{{ service.id }}">
                                        <button type="submit" class="border border-gray-300 rounded-md p-2 text-red-600 hover:bg-gray-50">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <dialog id="serviceModal" class="modal">
        <form method="post" action="/admin/services/add" class="modal-box max-w-3xl">
            <button type="button" onclick="document.getElementById('serviceModal').close()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            <h3 class="font-bold text-lg">Добавить услугу</h3>
            <div class="py-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="key">Ключ</label>
                        <input id="key" name="key" placeholder="permanent_makeup_brows" class="input input-bordered w-full" />
                    </div>
                    <div>
                        <label for="category">Категория</label>
                        <select id="category" name="category" class="select select-bordered w-full">
                            <option disabled selected>Выберите категорию</option>
                            {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>
                    <label for="name">Название (EN)</label>
                    <input id="name" name="name" placeholder="Permanent Makeup - Brows" class="input input-bordered w-full" />
                </div>
                <div>
                    <label for="nameRu">Название (RU)</label>
                    <input id="nameRu" name="nameRu" placeholder="Перманентный макияж бровей" class="input input-bordered w-full" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="price">Цена</label>
                        <input id="price" name="price" type="number" class="input input-bordered w-full" />
                    </div>
                    <div>
                        <label for="currency">Валюта</label>
                        <select id="currency" name="currency" class="select select-bordered w-full">
                            <option value="AED">AED</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="description">Описание (EN)</label>
                    <textarea id="description" name="description" placeholder="Professional brow tattooing" class="textarea textarea-bordered w-full"></textarea>
                </div>
                <div>
                    <label for="descriptionRu">Описание (RU)</label>
                    <textarea id="descriptionRu" name="descriptionRu" placeholder="Профессиональный татуаж бровей" class="textarea textarea-bordered w-full"></textarea>
                </div>
                <div>
                    <label for="benefits">Преимущества (разделяйте через |)</label>
                    <textarea id="benefits" name="benefits" placeholder="Long-lasting | Natural look | Waterproof" class="textarea textarea-bordered w-full"></textarea>
                </div>
            </div>
            <div class="modal-action">
                <button type="submit" class="btn bg-pink-600 text-white">Сохранить</button>
            </div>
        </form>
    </dialog>

    <!-- Edit Modal -->
    <dialog id="editModal" class="modal">
        <form method="post" id="editForm" class="modal-box max-w-3xl">
            <button type="button" onclick="document.getElementById('editModal').close()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            <h3 class="font-bold text-lg">Редактировать услугу</h3>
            <div class="py-4 space-y-4">
                <!-- Same fields as add -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit_key">Ключ</label>
                        <input id="edit_key" name="key" class="input input-bordered w-full" />
                    </div>
                    <div>
                        <label for="edit_category">Категория</label>
                        <select id="edit_category" name="category" class="select select-bordered w-full">
                            {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>
                    <label for="edit_name">Название (EN)</label>
                    <input id="edit_name" name="name" class="input input-bordered w-full" />
                </div>
                <div>
                    <label for="edit_nameRu">Название (RU)</label>
                    <input id="edit_nameRu" name="nameRu" class="input input-bordered w-full" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit_price">Цена</label>
                        <input id="edit_price" name="price" type="number" class="input input-bordered w-full" />
                    </div>
                    <div>
                        <label for="edit_currency">Валюта</label>
                        <select id="edit_currency" name="currency" class="select select-bordered w-full">
                            <option value="AED">AED</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="edit_description">Описание (EN)</label>
                    <textarea id="edit_description" name="description" class="textarea textarea-bordered w-full"></textarea>
                </div>
                <div>
                    <label for="edit_descriptionRu">Описание (RU)</label>
                    <textarea id="edit_descriptionRu" name="descriptionRu" class="textarea textarea-bordered w-full"></textarea>
                </div>
                <div>
                    <label for="edit_benefits">Преимущества (разделяйте через |)</label>
                    <textarea id="edit_benefits" name="benefits" class="textarea textarea-bordered w-full"></textarea>
                </div>
            </div>
            <div class="modal-action">
                <button type="submit" class="btn bg-pink-600 text-white">Сохранить</button>
            </div>
        </form>
    </dialog>

    <script>
        function editService(service) {
            document.getElementById('edit_key').value = service.key;
            document.getElementById('edit_category').value = service.category;
            document.getElementById('edit_name').value = service.name;
            document.getElementById('edit_nameRu').value = service.nameRu;
            document.getElementById('edit_price').value = service.price;
            document.getElementById('edit_currency').value = service.currency;
            document.getElementById('edit_description').value = service.description;
            document.getElementById('edit_descriptionRu').value = service.descriptionRu;
            document.getElementById('edit_benefits').value = service.benefits.join(' | ');
            document.getElementById('editForm').action = `/admin/services/edit/${service.id}`;
            document.getElementById('editModal').showModal();
        }
    </script>
</div>
{% endblock %}